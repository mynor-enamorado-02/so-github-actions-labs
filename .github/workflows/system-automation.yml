name: System Automation Workflow

on:
  workflow_dispatch:  # Ejecución manual
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

env:
  OUTPUT_DIR: "automation-output"
  LOG_FILE: "automation.log"

jobs:
  linux-automation:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout código
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Listar archivos (para debugging)
      run: |
        echo "Contenido del repositorio:"
        ls -la
        echo "Contenido de scripts/:"
        ls -la scripts/ || echo "Directorio scripts/ no existe"
    
    - name: Configurar variables de entorno
      run: |
        echo "JOB_ID=${{ github.run_id }}" >> $GITHUB_ENV
        echo "RUNNER_OS=${{ runner.os }}" >> $GITHUB_ENV
        echo "TIMESTAMP=$(date +%Y%m%d_%H%M%S)" >> $GITHUB_ENV
        echo "OUTPUT_DIR=automation-output" >> $GITHUB_ENV
        echo "LOG_FILE=automation.log" >> $GITHUB_ENV
    
    - name: Crear script si no existe (backup)
      run: |
        if [ ! -f "scripts/automation.sh" ]; then
          echo "Creando scripts/automation.sh automáticamente..."
          mkdir -p scripts
          cat > scripts/automation.sh << 'EOF'
        #!/bin/bash
        
        echo "=== Script de Automatización Linux ==="
        echo "Fecha: $(date)"
        echo "Directorio actual: $(pwd)"
        echo "Variables de entorno:"
        echo "JOB_ID: $JOB_ID"
        echo "RUNNER_OS: $RUNNER_OS"
        echo "TIMESTAMP: $TIMESTAMP"
        
        # Crear directorio de salida
        mkdir -p "$OUTPUT_DIR"
        
        # Crear archivo de ejemplo
        echo "Este es un archivo de prueba" > "$OUTPUT_DIR/test.txt"
        echo "Contenido del directorio $OUTPUT_DIR:" > "$OUTPUT_DIR/list.txt"
        ls -la >> "$OUTPUT_DIR/list.txt"
        
        echo "Script completado exitosamente"
        EOF
        fi
    
    - name: Hacer ejecutable el script
      run: |
        chmod +x scripts/automation.sh || echo "No se pudo hacer ejecutable"
        ls -la scripts/ || true
    
    - name: Ejecutar script de automatización (Linux)
      env:
        API_TOKEN: ${{ secrets.API_TOKEN || 'test-token-12345' }}
        DB_PASSWORD: ${{ secrets.DB_PASSWORD || 'test-pass-67890' }}
      run: |
        echo "Ejecutando script de automatización..."
        ./scripts/automation.sh 2>&1 | tee automation.log
        
        # Crear archivo de resultados si el script falló
        if [ ! -d "automation-output" ]; then
          mkdir -p automation-output
          echo "Script ejecutado pero no creó output" > automation-output/fallback.txt
        fi
    
    - name: Subir artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: linux-output-${{ env.TIMESTAMP }}
        path: |
          automation-output/
          automation.log
        retention-days: 7

  windows-automation:
    runs-on: windows-latest
    
    steps:
    - name: Checkout código
      uses: actions/checkout@v4
    
    - name: Listar archivos
      run: |
        echo "Contenido del repositorio:"
        dir
        echo "Contenido de scripts/:"
        dir scripts 2>nul || echo "Directorio scripts no existe"
    
    - name: Configurar variables
      run: |
        echo "JOB_ID=${{ github.run_id }}" | Out-File -FilePath $env:GITHUB_ENV -Append
        echo "RUNNER_OS=${{ runner.os }}" | Out-File -FilePath $env:GITHUB_ENV -Append
        echo "TIMESTAMP=$(Get-Date -Format 'yyyyMMdd_HHmmss')" | Out-File -FilePath $env:GITHUB_ENV -Append
    
    - name: Crear script PowerShell si no existe
      run: |
        if (!(Test-Path "scripts\automation.ps1")) {
          echo "Creando scripts\automation.ps1 automáticamente..."
          New-Item -ItemType Directory -Path "scripts" -Force | Out-Null
          @'
        # Script de Automatización Windows
        
        Write-Host "=== Script de Automatización Windows ==="
        Write-Host "Fecha: $(Get-Date)"
        Write-Host "Directorio actual: $(Get-Location)"
        Write-Host "Variables de entorno:"
        Write-Host "JOB_ID: $env:JOB_ID"
        Write-Host "RUNNER_OS: $env:RUNNER_OS"
        Write-Host "TIMESTAMP: $env:TIMESTAMP"
        
        # Crear directorio de salida
        New-Item -ItemType Directory -Path "automation-output" -Force | Out-Null
        
        # Crear archivo de ejemplo
        "Este es un archivo de prueba en Windows" | Out-File -FilePath "automation-output\test.txt"
        "Contenido del directorio:" | Out-File -FilePath "automation-output\list.txt"
        dir | Out-File -FilePath "automation-output\list.txt" -Append
        
        Write-Host "Script completado exitosamente"
        '@ | Out-File -FilePath "scripts\automation.ps1" -Encoding UTF8
        }
    
    - name: Ejecutar script PowerShell
      env:
        API_TOKEN: ${{ secrets.API_TOKEN || 'test-token-12345' }}
        DB_PASSWORD: ${{ secrets.DB_PASSWORD || 'test-pass-67890' }}
      run: |
        echo "Ejecutando script PowerShell..."
        powershell -ExecutionPolicy Bypass -File scripts\automation.ps1 2>&1 | Tee-Object -FilePath automation.log
        
        # Crear output si no existe
        if (!(Test-Path "automation-output")) {
          New-Item -ItemType Directory -Path "automation-output" -Force | Out-Null
          "Script ejecutado" | Out-File -FilePath "automation-output\fallback.txt"
        }
    
    - name: Subir artifacts Windows
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: windows-output-${{ env.TIMESTAMP }}
        path: |
          automation-output/
          automation.log
        retention-days: 7

  notify:
    needs: [linux-automation, windows-automation]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Notificar resultado
      run: |
        echo "=== Resumen del Workflow ==="
        echo "Fecha: $(date)"
        echo "Workflow: ${{ github.workflow }}"
        echo "Run ID: ${{ github.run_id }}"
        echo "Linux job: ${{ needs.linux-automation.result }}"
        echo "Windows job: ${{ needs.windows-automation.result }}"
        
        if [[ "${{ needs.linux-automation.result }}" == "success" && "${{ needs.windows-automation.result }}" == "success" ]]; then
          echo "✅ Todos los jobs completados exitosamente"
        else
          echo "⚠️  Algunos jobs tuvieron problemas"
          echo "Revisa los logs para más detalles"
        fi
