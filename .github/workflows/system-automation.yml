name: System Automation Workflow 

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

env:
  OUTPUT_DIR: "automation-output"
  LOG_FILE: "automation.log"

jobs:
  linux-automation:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up environment variables
      run: |
        echo "JOB_ID=${{ github.run_id }}" >> $GITHUB_ENV
        echo "RUNNER_OS=${{ runner.os }}" >> $GITHUB_ENV
        echo "TIMESTAMP=$(date +%Y%m%d_%H%M%S)" >> $GITHUB_ENV
    
    - name: Run Linux automation
      env:
        API_TOKEN: ${{ secrets.API_TOKEN || 'test-token-123' }}
        DB_PASSWORD: ${{ secrets.DB_PASSWORD || 'test-pass-456' }}
      run: |
        mkdir -p "$OUTPUT_DIR"
        
        echo "=== Linux Automation ===" > "$OUTPUT_DIR/linux_results.txt"
        echo "Timestamp: $(date)" >> "$OUTPUT_DIR/linux_results.txt"
        echo "Job ID: $JOB_ID" >> "$OUTPUT_DIR/linux_results.txt"
        
        echo "" >> "$OUTPUT_DIR/linux_results.txt"
        echo "Repository contents:" >> "$OUTPUT_DIR/linux_results.txt"
        ls -la >> "$OUTPUT_DIR/linux_results.txt"
        
        echo "Creating files with different permissions..." >> "$OUTPUT_DIR/linux_results.txt"
        echo "Readable file" > "$OUTPUT_DIR/readable.txt"
        chmod 644 "$OUTPUT_DIR/readable.txt"
        
        echo "Executable script" > "$OUTPUT_DIR/script.sh"
        chmod +x "$OUTPUT_DIR/script.sh"
        
        echo "Starting background process..." >> "$OUTPUT_DIR/linux_results.txt"
        (sleep 3; echo "Background process completed at $(date)" > "$OUTPUT_DIR/background_done.txt") &
        BG_PID=$!
        echo "Background process PID: $BG_PID" >> "$OUTPUT_DIR/linux_results.txt"
        
        echo "" >> "$OUTPUT_DIR/linux_results.txt"
        echo "Environment variables:" >> "$OUTPUT_DIR/linux_results.txt"
        echo "API_TOKEN length: ${#API_TOKEN}" >> "$OUTPUT_DIR/linux_results.txt"
        echo "DB_PASSWORD length: ${#DB_PASSWORD}" >> "$OUTPUT_DIR/linux_results.txt"
        echo "RUNNER_OS: $RUNNER_OS" >> "$OUTPUT_DIR/linux_results.txt"
        
        cat > "$OUTPUT_DIR/summary.json" << EOF
        {
          "status": "success",
          "platform": "linux",
          "timestamp": "$(date -Iseconds)",
          "job_id": "$JOB_ID",
          "files_created": ["linux_results.txt", "readable.txt", "script.sh", "summary.json"],
          "background_process_pid": $BG_PID
        }
        EOF
        
        wait $BG_PID
        echo "✅ Linux automation completed successfully"
        echo "Workflow log - Linux" > "$LOG_FILE"
        echo "Completed at: $(date)" >> "$LOG_FILE"
    
    - name: Upload Linux artifacts
      uses: actions/upload-artifact@v4
      with:
        name: linux-automation-results
        path: |
          automation-output/
          automation.log

  windows-automation:
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up environment variables
      run: |
        echo "JOB_ID=${{ github.run_id }}" | Out-File -FilePath $env:GITHUB_ENV -Append
        echo "RUNNER_OS=${{ runner.os }}" | Out-File -FilePath $env:GITHUB_ENV -Append
        echo "TIMESTAMP=$(Get-Date -Format 'yyyyMMdd_HHmmss')" | Out-File -FilePath $env:GITHUB_ENV -Append
    
    - name: Run Windows automation
      env:
        API_TOKEN: ${{ secrets.API_TOKEN || 'test-token-123' }}
        DB_PASSWORD: ${{ secrets.DB_PASSWORD || 'test-pass-456' }}
      run: |
        if (!(Test-Path "$env:OUTPUT_DIR")) {
            New-Item -ItemType Directory -Path "$env:OUTPUT_DIR" -Force | Out-Null
        }
        
        $scriptContent = @'
        Write-Host "=== Windows Automation ==="
        
        $output = @"
        === Windows Automation ===
        Timestamp: $(Get-Date)
        Job ID: $env:JOB_ID
        
        Repository contents:
        "@
        
        $files = Get-ChildItem -Path . -Recurse -Depth 1 | Select-Object Name, Length, LastWriteTime
        $output += "`r`n" + ($files | Format-Table -AutoSize | Out-String)
        $output | Out-File -FilePath "$env:OUTPUT_DIR\windows_results.txt" -Encoding UTF8
        
        "Test file content" | Out-File -FilePath "$env:OUTPUT_DIR\test_file.txt" -Encoding UTF8
        Write-Host "Created test file"
        
        Write-Host "Starting background job..."
        $job = Start-Job -ScriptBlock {
            Start-Sleep -Seconds 3
            "Background job completed at $(Get-Date)" | Out-File -FilePath "$using:env:OUTPUT_DIR\background_done.txt" -Encoding UTF8
        }
        Write-Host "Background job ID: $($job.Id)"
        
        $envInfo = @"
        
        Environment variables:
        API_TOKEN length: $($env:API_TOKEN.Length)
        DB_PASSWORD length: $($env:DB_PASSWORD.Length)
        RUNNER_OS: $env:RUNNER_OS
        Computer: $env:COMPUTERNAME
        User: $env:USERNAME
        "@
        
        $envInfo | Out-File -FilePath "$env:OUTPUT_DIR\windows_results.txt" -Append -Encoding UTF8
        
        $jsonContent = @"
        {
          "status": "success",
          "platform": "windows",
          "timestamp": "$(Get-Date -Format 'yyyy-MM-ddTHH:mm:ss')",
          "job_id": "$env:JOB_ID",
          "files_created": ["windows_results.txt", "test_file.txt", "summary.json"],
          "background_job_id": $($job.Id)
        }
        "@
        
        $jsonContent | Out-File -FilePath "$env:OUTPUT_DIR\summary.json" -Encoding UTF8
        
        $job | Wait-Job | Out-Null
        $job | Remove-Job -Force
        
        Write-Host "✅ Windows automation completed successfully"
        '@
        
        $scriptContent | Out-File -FilePath "automation.ps1" -Encoding UTF8
        powershell -ExecutionPolicy Bypass -File "automation.ps1"
        
        "Workflow log - Windows" | Out-File -FilePath "$env:LOG_FILE" -Encoding UTF8
        "Completed at: $(Get-Date)" | Out-File -FilePath "$env:LOG_FILE" -Append -Encoding UTF8
    
    - name: Upload Windows artifacts
      uses: actions/upload-artifact@v4
      with:
        name: windows-automation-results
        path: |
          automation-output/
          automation.log

  summary:
    runs-on: ubuntu-latest
    needs: [linux-automation, windows-automation]
    if: always()
    
    steps:
    - name: Display workflow results
      run: |
        echo "=== WORKFLOW SUMMARY ==="
        echo "Workflow: ${{ github.workflow }}"
        echo "Run ID: ${{ github.run_id }}"
        echo "Run URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        echo ""
        echo "JOB RESULTS:"
        echo "- Linux: ${{ needs.linux-automation.result }}"
        echo "- Windows: ${{ needs.windows-automation.result }}"
        echo ""
        if [ "${{ needs.linux-automation.result }}" = "success" ] && [ "${{ needs.windows-automation.result }}" = "success" ]; then
          echo "ALL JOBS COMPLETED SUCCESSFULLY!"
          echo "Artifacts are available for download."
        else
          echo "Some jobs had issues"
          echo "Check the logs for details"
        fi
