name: Docker Container Workflow Rápido

on:
  workflow_dispatch:

jobs:
  docker-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Crear Dockerfile
      run: |
        cat > Dockerfile << 'EOF'
        FROM busybox:latest
        
        # Crear aplicación simple sin instalar nada
        RUN echo '#!/bin/sh' > /app/start.sh && \
            echo 'echo "Server starting on port 8080..."' >> /app/start.sh && \
            echo 'while true; do' >> /app/start.sh && \
            echo '  echo -e "HTTP/1.1 200 OK\\n\\nOK from container at $(date)" | nc -l -p 8080' >> /app/start.sh && \
            echo 'done' >> /app/start.sh && \
            chmod +x /app/start.sh
        
        WORKDIR /app
        EXPOSE 8080
        CMD ["./start.sh"]
        EOF
        
    - name: Construir y ejecutar
      run: |
        # Construir
        docker build -t test-app .
        
        # Ejecutar
        docker run -d --name test -p 8080:8080 test-app
        sleep 2
        
        # Probar comunicación
        echo "Probando conexión..."
        timeout 5s bash -c 'until curl -s http://localhost:8080; do sleep 1; done' || true
        
        # Monitorear
        echo "Estadísticas:"
        docker stats test --no-stream
        
        # Limpiar
        docker stop test
        docker rm test
        docker rmi test-app
