name: Release and Deploy

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production

jobs:
  find-project:
    name: Find Project Directory
    runs-on: ubuntu-latest
    outputs:
      project_dir: ${{ steps.find_dir.outputs.PROJECT_DIR }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Find project directory
      id: find_dir
      run: |
        echo "Listing directory contents:"
        ls -la
        if [ -d "Fase 3 Proyecto Integrador" ]; then
          echo "Found: Fase 3 Proyecto Integrador"
          echo "PROJECT_DIR=Fase 3 Proyecto Integrador" >> $GITHUB_OUTPUT
        elif [ -d "Fate 3 Proyecto Integrador" ]; then
          echo "Found: Fate 3 Proyecto Integrador"
          echo "PROJECT_DIR=Fate 3 Proyecto Integrador" >> $GITHUB_OUTPUT
        elif [ -d "Proyecto Integrador" ]; then
          echo "Found: Proyecto Integrador"
          echo "PROJECT_DIR=Proyecto Integrador" >> $GITHUB_OUTPUT
        else
          echo "WARNING: No project directory found, using root"
          echo "PROJECT_DIR=." >> $GITHUB_OUTPUT
        fi

  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: find-project
    if: startsWith(github.ref, 'refs/tags/v')
    
    outputs:
      release_id: ${{ steps.create_release.outputs.id }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Get version from tag
      id: get_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
    
    - name: Generate changelog
      run: |
        echo "# Release Notes v${{ steps.get_version.outputs.VERSION }}" > CHANGELOG.md
        echo "## Date: $(date +%Y-%m-%d)" >> CHANGELOG.md
        echo "## Changes:" >> CHANGELOG.md
        git log --oneline --decorate=no $(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")..HEAD | sed 's/^/- /' >> CHANGELOG.md
    
    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: Release v${{ steps.get_version.outputs.VERSION }}
        body_path: CHANGELOG.md
        draft: false
        prerelease: false
    
    - name: Build package
      run: |
        cd "${{ needs.find-project.outputs.project_dir }}"
        python -m pip install --upgrade pip build
        python -m build
    
    - name: Upload release artifacts to workflow
      uses: actions/upload-artifact@v4
      with:
        name: release-packages
        path: ${{ needs.find-project.outputs.project_dir }}/dist/
        retention-days: 90

  test-release:
    name: Test Release
    runs-on: ubuntu-latest
    needs: [find-project, create-release]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Test the release
      run: |
        cd "${{ needs.find-project.outputs.project_dir }}"
        echo "Testing release in directory: $PWD"
        ls -la
        if [ -d "src" ]; then
          echo "Running application test..."
          python -m src.app --help || python -m src.app || echo "Application executed"
        fi

  notification:
    name: Send Notification
    runs-on: ubuntu-latest
    needs: [create-release, test-release]
    if: always()
    
    steps:
    - name: Release status
      run: |
        if ${{ success() }}; then
          echo "✅ Release ${{ github.ref_name }} created successfully!"
          echo "Project directory: ${{ needs.find-project.outputs.project_dir }}"
        else
          echo "❌ Release ${{ github.ref_name }} failed!"
          echo "Check workflow logs for details."
        fi
